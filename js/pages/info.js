document.addEventListener('DOMContentLoaded', function() {
    // ËÆæÁΩÆÊñá‰ª∂È¢ÑËßà
    setupFilePreview('infoPhoto');

    // Ëé∑ÂèñDOMÂÖÉÁ¥†
    const viewInfoBtn = document.getElementById('viewInfoBtn');

    // ËØ≠Ë®ÄÈÖçÁΩÆ
    const translations = {
        zh: {
            selectFile: 'ËØ∑ÈÄâÊã©ÁÖßÁâáÊñá‰ª∂',
            loading: 'ËØªÂèñ‰∏≠...',
            readError: 'Êó†Ê≥ïËØªÂèñÁÖßÁâá‰ø°ÊÅØÔºåËøôÂèØËÉΩ‰∏çÊòØ‰∏Ä‰∏™ÊúâÊïàÁöÑÂõæÁâáÊñá‰ª∂',
            processError: 'Êó†Ê≥ïÂ§ÑÁêÜËøô‰∏™Êñá‰ª∂ÔºåËØ∑Á°Æ‰øùÂÆÉÊòØ‰∏Ä‰∏™ÊúâÊïàÁöÑÂõæÁâáÊñá‰ª∂',
            noInfo: '‚ö†Ô∏è Ê≥®ÊÑè: ËøôÂº†ÁÖßÁâáÊ≤°ÊúâÂåÖÂê´Êõ¥Â§öÂèØËØªÂèñÁöÑ‰ø°ÊÅØ',
            basicInfo: 'üì∏ Âü∫Êú¨‰ø°ÊÅØ:',
            fileName: 'Êñá‰ª∂ÂêçÁß∞',
            fileSize: 'Êñá‰ª∂Â§ßÂ∞è',
            imageSize: 'ÂõæÁâáÂ∞∫ÂØ∏',
            shootingInfo: 'üì± ÊãçÊëÑ‰ø°ÊÅØ:',
            deviceBrand: 'ËÆæÂ§áÂìÅÁâå',
            deviceModel: 'ËÆæÂ§áÂûãÂè∑',
            shootingTime: 'ÊãçÊëÑÊó∂Èó¥',
            shootingParams: 'üéØ ÊãçÊëÑÂèÇÊï∞:',
            shutterSpeed: 'Âø´Èó®ÈÄüÂ∫¶',
            seconds: 'Áßí',
            aperture: 'ÂÖâÂúàÂÄº',
            iso: 'ISOÊÑüÂÖâÂ∫¶',
            focalLength: 'ÁÑ¶Ë∑ù',
            locationInfo: 'üìç ‰ΩçÁΩÆ‰ø°ÊÅØ:',
            coordinates: 'ÂùêÊ†á',
            softwareInfo: 'üíª ËΩØ‰ª∂‰ø°ÊÅØ:',
            processingSoftware: 'Â§ÑÁêÜËΩØ‰ª∂',
            motionPhotoInfo: 'üé• Âä®ÊÄÅÁÖßÁâá‰ø°ÊÅØ:',
            xiaomiMotionPhoto: 'Á±ªÂûã: Â∞èÁ±≥Âä®ÊÄÅÁÖßÁâá',
            oppoMotionPhoto: 'Á±ªÂûã: OPPO Âä®ÊÄÅÁÖßÁâá',
            otherMotionPhoto: 'Á±ªÂûã: ÂÖ∂‰ªñÂìÅÁâåÂä®ÊÄÅÁÖßÁâá'
        },
        en: {
            selectFile: 'Please select a photo file',
            loading: 'Loading...',
            readError: 'Unable to read photo information, this might not be a valid image file',
            processError: 'Unable to process this file, please ensure it is a valid image file',
            noInfo: '‚ö†Ô∏è Note: This photo does not contain more readable information',
            basicInfo: 'üì∏ Basic Information:',
            fileName: 'File Name',
            fileSize: 'File Size',
            imageSize: 'Image Size',
            shootingInfo: 'üì± Shooting Information:',
            deviceBrand: 'Device Brand',
            deviceModel: 'Device Model',
            shootingTime: 'Shooting Time',
            shootingParams: 'üéØ Shooting Parameters:',
            shutterSpeed: 'Shutter Speed',
            seconds: 'sec',
            aperture: 'Aperture',
            iso: 'ISO',
            focalLength: 'Focal Length',
            locationInfo: 'üìç Location Information:',
            coordinates: 'Coordinates',
            softwareInfo: 'üíª Software Information:',
            processingSoftware: 'Processing Software',
            motionPhotoInfo: 'üé• Motion Photo Information:',
            xiaomiMotionPhoto: 'Type: Xiaomi Motion Photo',
            oppoMotionPhoto: 'Type: OPPO Motion Photo',
            otherMotionPhoto: 'Type: Other Brand Motion Photo'
        }
    };

    // ÈªòËÆ§ËØ≠Ë®Ä
    const DEFAULT_LANG = 'zh';

    // Ëé∑ÂèñÊúâÊïàÁöÑËØ≠Ë®ÄËÆæÁΩÆ
    function getValidLang(selectedLang) {
        return translations[selectedLang] ? selectedLang : DEFAULT_LANG;
    }

    // Êü•Áúã‰ø°ÊÅØÂäüËÉΩ
    viewInfoBtn.addEventListener('click', async function() {
        const photo = document.getElementById('infoPhoto').files[0];
        const selectedLang = document.getElementById('infoLang')?.value;
        const lang = getValidLang(selectedLang);

        if (!photo) {
            showResult(translations[lang].selectFile, true);
            return;
        }

        try {
            showResult(translations[lang].loading);
            const info = await getPhotoInfo(photo, lang);
            showResult(info);
        } catch (error) {
            showResult(`${translations[lang].readError}: ${error.message}`, true);
        }
    });

    // ËØªÂèñÁÖßÁâá‰ø°ÊÅØ
    async function getPhotoInfo(photo, lang) {
        const t = translations[lang];
        return new Promise((resolve, reject) => {
            try {
                EXIF.getData(photo, function() {
                    try {
                        const info = [];
                        let exif = {};
                        
                        // Âü∫Êú¨‰ø°ÊÅØÔºà‰∏ç‰æùËµñEXIFÔºâ
                        info.push(t.basicInfo);
                        info.push(`${t.fileName}: ${photo.name}`);
                        info.push(`${t.fileSize}: ${(photo.size / 1024 / 1024).toFixed(2)}MB`);
                        
                        // Â∞ùËØïËé∑ÂèñEXIFÊï∞ÊçÆ
                        try {
                            exif = EXIF.getAllTags(this) || {};
                        } catch (e) {
                            console.warn('ËØªÂèñEXIFÊï∞ÊçÆÊó∂Âá∫Èîô:', e);
                            exif = {};
                        }

                        // ÂõæÁâáÂ∞∫ÂØ∏
                        if (exif.PixelXDimension && exif.PixelYDimension) {
                            info.push(`${t.imageSize}: ${exif.PixelXDimension} √ó ${exif.PixelYDimension} px`);
                        }
                        
                        // ÊãçÊëÑ‰ø°ÊÅØ
                        if (exif.Make || exif.Model || exif.DateTime) {
                            info.push(`\n${t.shootingInfo}`);
                            if (exif.Make) info.push(`${t.deviceBrand}: ${exif.Make}`);
                            if (exif.Model) info.push(`${t.deviceModel}: ${exif.Model}`);
                            if (exif.DateTime) info.push(`${t.shootingTime}: ${exif.DateTime}`);
                        }
                        
                        // ÊãçÊëÑÂèÇÊï∞
                        if (exif.ExposureTime || exif.FNumber || exif.ISOSpeedRatings || exif.FocalLength) {
                            info.push(`\n${t.shootingParams}`);
                            if (exif.ExposureTime) {
                                const exposureTime = exif.ExposureTime < 1 
                                    ? `1/${Math.round(1/exif.ExposureTime)}` 
                                    : exif.ExposureTime;
                                info.push(`${t.shutterSpeed}: ${exposureTime} ${t.seconds}`);
                            }
                            if (exif.FNumber) info.push(`${t.aperture}: f/${exif.FNumber}`);
                            if (exif.ISOSpeedRatings) info.push(`${t.iso}: ${exif.ISOSpeedRatings}`);
                            if (exif.FocalLength) info.push(`${t.focalLength}: ${exif.FocalLength}mm`);
                        }
                        
                        // GPS‰ø°ÊÅØ
                        try {
                            if (exif.GPSLatitude && exif.GPSLongitude) {
                                info.push(`\n${t.locationInfo}`);
                                const lat = convertDMSToDD(exif.GPSLatitude, exif.GPSLatitudeRef);
                                const lng = convertDMSToDD(exif.GPSLongitude, exif.GPSLongitudeRef);
                                info.push(`${t.coordinates}: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
                            }
                        } catch (e) {
                            console.warn('Ëß£ÊûêGPS‰ø°ÊÅØÊó∂Âá∫Èîô:', e);
                        }
                        
                        // ËΩØ‰ª∂‰ø°ÊÅØ
                        if (exif.Software) {
                            info.push(`\n${t.softwareInfo}`);
                            info.push(`${t.processingSoftware}: ${exif.Software}`);
                        }

                        // Âä®ÊÄÅÁÖßÁâáÁõ∏ÂÖ≥‰ø°ÊÅØ
                        try {
                            const motionPhotoInfo = getMotionPhotoInfo(exif, lang);
                            if (motionPhotoInfo) {
                                info.push(`\n${t.motionPhotoInfo}`);
                                info.push(motionPhotoInfo);
                            }
                        } catch (e) {
                            console.warn('Ê£ÄÊü•Âä®ÊÄÅÁÖßÁâá‰ø°ÊÅØÊó∂Âá∫Èîô:', e);
                        }

                        if (info.length <= 3) {
                            info.push(`\n${t.noInfo}`);
                        }

                        resolve(info.join('\n'));
                    } catch (error) {
                        console.error('Ëß£ÊûêÁÖßÁâá‰ø°ÊÅØÊó∂Âá∫Èîô:', error);
                        reject(new Error(t.readError));
                    }
                });
            } catch (error) {
                console.error('EXIF.getDataË∞ÉÁî®Â§±Ë¥•:', error);
                reject(new Error(t.processError));
            }
        });
    }

    // Â∞ÜGPSÁöÑÂ∫¶ÂàÜÁßíÊ†ºÂºèËΩ¨Êç¢‰∏∫ÂçÅËøõÂà∂Â∫¶Êï∞
    function convertDMSToDD(dms, ref) {
        try {
            const degrees = dms[0] || 0;
            const minutes = dms[1] || 0;
            const seconds = dms[2] || 0;
            
            let dd = degrees + minutes/60 + seconds/3600;
            if (ref === 'S' || ref === 'W') {
                dd = dd * -1;
            }
            return dd;
        } catch (e) {
            console.warn('GPSÂùêÊ†áËΩ¨Êç¢Âá∫Èîô:', e);
            return 0;
        }
    }

    // Ëé∑ÂèñÂä®ÊÄÅÁÖßÁâáÁõ∏ÂÖ≥‰ø°ÊÅØ
    function getMotionPhotoInfo(exif, lang) {
        const t = translations[lang];
        try {
            // Ê£ÄÊü•Â∞èÁ±≥Âä®ÊÄÅÁÖßÁâáÊ†áËÆ∞
            if (exif.MiMotionPhoto || exif.MiMotionPhotoVersion) {
                return t.xiaomiMotionPhoto;
            }
            
            // Ê£ÄÊü• OPPO Âä®ÊÄÅÁÖßÁâáÊ†áËÆ∞
            if (exif.Software && exif.Software.includes('OPPO')) {
                return t.oppoMotionPhoto;
            }

            // Ê£ÄÊü•ÂÖ∂‰ªñÂèØËÉΩÁöÑÂä®ÊÄÅÁÖßÁâáÊ†áËÆ∞
            const keys = Object.keys(exif);
            if (keys.some(key => 
                key.toLowerCase().includes('motion') || 
                key.toLowerCase().includes('live') ||
                key.toLowerCase().includes('dynamic'))) {
                return t.otherMotionPhoto;
            }
        } catch (e) {
            console.warn('Ê£ÄÊü•Âä®ÊÄÅÁÖßÁâáÁ±ªÂûãÊó∂Âá∫Èîô:', e);
        }

        return null;
    }
}); 